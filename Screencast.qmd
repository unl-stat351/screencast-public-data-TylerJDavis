---
title: "Screencast"
author: "Tyler Davis"
format: html
editor: visual
---

## Screen cast using Baseball Reference Data

Reading in Data and analysis

```{r}
library(rvest)
library(httr2)
library(tidyverse)

html <- read_html("https://www.baseball-reference.com/teams/CHC/index.shtml")

tables <- html %>%
  html_table()

cubs <- data.frame(tables[[1]])

worse_year <- cubs %>%
  filter(W.L. <= .450)
best_year <- cubs %>%
  filter(W.L. >= .650)

best_year$type <- "W.P. >= .650"
worse_year$type <- "W.P. <= .450"

years <- rbind(worse_year,best_year)

cubs_years <- cubs %>%
  filter(!Year %in% years$Year)

cubs_years$type <- ".450 < W.P. < .650"

cubs_total <- rbind(cubs_years,years)

library(mlbplotR)

colors <- load_mlb_teams() %>%
  filter(team_name == "Chicago Cubs") %>%
  select(team_color,team_color2)
```

Graphing Cubs Data

```{r}
cubs_total %>%
  ggplot(aes(x = Year,y = W.L.,fill = type)) + geom_col() +
  scale_fill_manual( values = c(
    "W.P. >= .650" = colors$team_color,
    ".450 < W.P. < .650" = "gray",
    "W.P. <= .450" = colors$team_color2)) + labs(
      title = "Comparing Winning Percentages Across Years",
      x = "Year",
      y = "Winning Percentage",
      fill = "Winning Catagory"
    )




cubs$winning_catagory <- cut(cubs$W.L.,breaks = c(0,.4,.5,.6,1),labels = c("0-.4 Winning Percentage",".4-.5 Winning Percentage", ".5-.6 Winning Percentage",".6 and above Winning Percentage"))




ggplot(cubs,aes(x = Year,y = W.L.,fill = Lg)) + geom_col() + labs(
  title = "Cubs Winning Percentage in Each Division",
  x = "Year",
  y = "WL Percentage",
  fill = "Division"
)


cubs$playoffs_app <- ifelse(str_detect(cubs$Playoffs,"o"),1,0)

ggplot(cubs,aes(x = Year,y = W.L.,fill = factor(playoffs_app))) + geom_col() + labs(
  title = "Cubs Playoff Appearances All Time",
  x = "Year",
  y = "W.L. Percentage",
  fill = "Playoff Apperance"
)

```

Best hitter function

```{r}
library(rvest)
library(httr2)
library(tidyverse)

mlb_codes_table <- read_html("https://www.baseball-reference.com/about/team_IDs.shtml") %>%
  html_table()
mlb_code <- mlb_codes_table[[1]]
columns <- mlb_code[1,]
colnames(mlb_code) <- columns
mlb_key <- mlb_code[-1,c(2:5)]



#putting it into a function
team_info <- function(Team_code,year,stat,season){
  url <- paste("https://www.baseball-reference.com/teams/",Team_code,"/",year,".shtml", sep= "")

  team_dat_1 <- read_html(url) %>%
  html_table()
  
  if(length(team_dat_1) == 4){
  
  if(stat == "Hitting" && season == "Regular"){
    data <- data.frame(team_dat_1[[1]])
    return(data)
  } else if(stat == "Hitting" && season == "Playoff"){
    data <- data.frame(team_dat_1[[2]])
    return(data)
  } else if(stat == "Pitching" && season == "Regular"){
    data <- data.frame(team_dat_1[[3]])
    return(data)
  } else if(stat == "Pitching" && season == "Playoff"){
    data <- data.frame(team_dat_1[[4]])
    return(data)
  }
    
  } else if(length(team_dat_1) == 2){
   if(season == "Playoff"){
     return("Your Team did not make the playoffs this year")
   } else if(stat == "Hitting"){
     data <- data.frame(team_dat_1[[1]])
     return(data)
   }else if(stat == "Pitching"){
     data <- data.frame(team_dat_1[[2]])
     return(data)
   }
  } else{
    return("You did not put your input in the right format. All inputs to this function must be string variables")
  }
}  
  
data <- team_info("CHC","2016","Hitting","Regular")

data_clean <- data[c(1:8,10:21,23:47),]

cols <- data.frame(colnames(data_clean))

best_hitter_long <- data_clean %>%
  pivot_longer(
    cols = c(5:6,8:15,17:23),
    names_to = "Metric",
    values_to = "Score"
  )
  




best_hitter <- best_hitter_long %>%
  select(2:4,17:18) %>%
  group_by(Metric) %>%
  mutate(rank = case_when(
    Metric == "SO" ~dense_rank(as.numeric(Score)),
    TRUE ~dense_rank(desc(as.numeric(Score))))
  )

avg_rank <- best_hitter %>%
  group_by(Player) %>%
  summarise(rank_total = sum(rank),
            mean_rank = mean(rank))%>%
  arrange(rank_total,mean_rank)


best_hitter %>%
  filter(Player %in% avg_rank$Player[1:2]) %>%
  ggplot(aes(x = Metric,y = rank, fill = Player)) + geom_col(position = "dodge") + labs(
    title = "Comparing Ranks of the Two Best Hitters",
    x = "Metric",
    y = "Rank",
    fill = "Player"
  )
```

```{r}
library(readr)
library(tidyverse)
sta_dat <- read_csv("Major_League_Baseball_Stadiums_(with_Placekey).csv") %>%
  mutate(TEAM = ifelse(TEAM == "Cleveland Indians", "Cleveland Guardians", TEAM))



team_stadium <- function(team){
library(leaflet)
library(tidyverse)
library(mlbplotR)
team_info <- load_mlb_teams() %>%
  filter(team_name == team) %>%
  select(team_color,team_logo_espn)

color <- team_info$team_color
logo <- team_info$team_logo_espn



sta_dat %>%
  filter(TEAM == team) %>%
  leaflet() %>%
  addTiles %>%
  addCircleMarkers(
    lat = ~LATITUDE,
    lng = ~LONGITUDE,
    color = color,
    fillColor = color,
    fillOpacity = .8,
    popup = ~paste0(
      '<img src="',logo,'" style="width:150px;height:auto;">',"<br>",
      "Stadium: ",NAME,"<br>",
      "Capacity: ", CAPACITY)
  )


}


team_stadium("Chicago Cubs")



#Shiney App
library(shiny)
library(tidyverse)
library(shinydashboard)

ui <- fluidPage(
  h1("MLB Team Stadium"),
  selectInput("team","Select Team",sta_dat$TEAM),
  leafletOutput("map",height = 600)
)

server <- function(input,output){
  output$map <- renderLeaflet({
    req(input$team)
    team_stadium(input$team)
  })
}

shinyApp(ui,server)
```
